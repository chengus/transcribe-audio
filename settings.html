<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/src/styles.css" />
    <title>Settings</title>
</head>
<body>
        <main id="app">
            <section class="card">
                <h2>Settings</h2>
                <p>Configure application options here.</p>
                <div style="margin-top:16px">
                    <a href="index.html" class="ghost-btn">Back</a>
                </div>
            </section>

            <section class="card">
                <h2>Models</h2>
                <p class="muted">Manage model downloads and cache.</p>

                <div id="models" class="model-list" aria-live="polite"></div>
            </section>
        </main>

        <script>
            (function () {
                const MODEL_KEYS = ['tiny','base','small','medium','large'];
                const STORAGE_KEY = 'app:modelStates:v1';

                function defaultState() {
                    const obj = {};
                    MODEL_KEYS.forEach(k => {
                        obj[k] = { state: 'not-downloaded', progress: 0 };
                    });
                    return obj;
                }

                function loadStates() {
                    try {
                        const raw = localStorage.getItem(STORAGE_KEY);
                        if (!raw) return defaultState();
                        const parsed = JSON.parse(raw);
                        // ensure defaults exist
                        const def = defaultState();
                        return Object.assign(def, parsed);
                    } catch (e) {
                        console.error('failed to load model states', e);
                        return defaultState();
                    }
                }

                function saveStates(states) {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(states));
                }

                function createActionButton(text, cls, handler) {
                    const btn = document.createElement('button');
                    btn.className = cls;
                    btn.textContent = text;
                    btn.addEventListener('click', handler);
                    return btn;
                }

                function render() {
                    const container = document.getElementById('models');
                    container.innerHTML = '';
                    const states = loadStates();

                    MODEL_KEYS.forEach(key => {
                        const item = document.createElement('div');
                        item.className = 'model-item';

                        const left = document.createElement('div');
                        left.className = 'model-info';
                        const title = document.createElement('div');
                        title.className = 'model-name';
                        title.textContent = key;
                        const status = document.createElement('div');
                        status.className = 'model-status';
                        status.textContent = states[key].state === 'not-downloaded' ? 'Not downloaded' : (states[key].state === 'downloading' ? `Downloading (${states[key].progress}%)` : 'Downloaded');
                        left.appendChild(title);
                        left.appendChild(status);

                        const actions = document.createElement('div');
                        actions.className = 'model-actions';

                        // Download button (visible when not-downloaded)
                        if (states[key].state === 'not-downloaded') {
                            const dl = createActionButton('Download', 'ghost-btn', () => startDownload(key));
                            actions.appendChild(dl);
                        }

                        // Cancel button (visible when downloading)
                        if (states[key].state === 'downloading') {
                            const cancel = createActionButton('Cancel', 'ghost-btn', () => cancelDownload(key));
                            actions.appendChild(cancel);
                        }

                        // Delete button (visible when downloaded)
                        if (states[key].state === 'downloaded') {
                            const del = createActionButton('Delete', 'ghost-btn', () => deleteDownload(key));
                            actions.appendChild(del);
                        }

                        // progress bar
                        const progWrap = document.createElement('div');
                        progWrap.className = 'model-progress-wrap';
                        const prog = document.createElement('div');
                        prog.className = 'model-progress';
                        prog.style.width = states[key].progress + '%';
                        progWrap.appendChild(prog);

                        item.appendChild(left);
                        item.appendChild(actions);
                        item.appendChild(progWrap);
                        container.appendChild(item);
                    });
                }

                const downloadTimers = {};

                function startDownload(key) {
                    const states = loadStates();
                    if (states[key].state === 'downloading') return;
                    states[key].state = 'downloading';
                    states[key].progress = 0;
                    saveStates(states);
                    render();

                    // fake download progression
                    downloadTimers[key] = setInterval(() => {
                        const s = loadStates();
                        if (s[key].state !== 'downloading') {
                            clearInterval(downloadTimers[key]);
                            return;
                        }
                        s[key].progress = Math.min(100, s[key].progress + Math.floor(Math.random()*12) + 8);
                        if (s[key].progress >= 100) {
                            s[key].progress = 100;
                            s[key].state = 'downloaded';
                            clearInterval(downloadTimers[key]);
                        }
                        saveStates(s);
                        render();
                    }, 700);
                }

                function cancelDownload(key) {
                    const states = loadStates();
                    if (states[key].state !== 'downloading') return;
                    states[key].state = 'not-downloaded';
                    states[key].progress = 0;
                    saveStates(states);
                    if (downloadTimers[key]) {
                        clearInterval(downloadTimers[key]);
                        delete downloadTimers[key];
                    }
                    render();
                }

                function deleteDownload(key) {
                    const states = loadStates();
                    if (states[key].state !== 'downloaded') return;
                    states[key].state = 'not-downloaded';
                    states[key].progress = 0;
                    saveStates(states);
                    render();
                }

                // initial render
                render();

                // expose for console/debug
                window.__modelStateHelpers = { startDownload, cancelDownload, deleteDownload, loadStates, saveStates };
            })();
        </script>
</body>
</html>
